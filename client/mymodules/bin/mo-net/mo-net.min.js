var pomeloClient;!function(e){var t=function(){function e(){this.JS_WS_CLIENT_TYPE="js-websocket",this.JS_WS_CLIENT_VERSION="0.0.1",this.RES_OK=200,this.RES_FAIL=500,this.RES_OLD_CLIENT=501,this.handlers={},this._callbacks={},this.callbacks={},this.routeMap={},this.heartbeatId=null,this.heartbeatTimeoutId=null,this.heartbeatTimeout=0,this.nextHeartbeatTimeout=0,this.heartbeatInterval=0,this.gapThreshold=100,this.notify=function(e,t){t=t||{},this.sendMessage(0,e,t)},this["package"]=new r,this.protocol=new o,this.message=new n,this.handlers[r.TYPE_HANDSHAKE]=this.handshake,this.handlers[r.TYPE_HEARTBEAT]=this.heartbeat,this.handlers[r.TYPE_DATA]=this.onData,this.handlers[r.TYPE_KICK]=this.onKick,this.handshakeBuffer={sys:{type:this.JS_WS_CLIENT_TYPE,version:this.JS_WS_CLIENT_VERSION},user:{}},this.reqId=0}var t=(__define,e),i=t.prototype;return i.init=function(e,t){this.initCallback=t,this.initEgretSocket(e.host,e.port,t)},i.initEgretSocket=function(e,t,n){var o=this;o.socket=new egret.WebSocket(e,t),console.log("init"),o.socket.addEventListener(egret.Event.CONNECT,function(){console.log("CONNECT");var e=o["package"].encode(r.TYPE_HANDSHAKE,o.protocol.strencode(JSON.stringify(o.handshakeBuffer)));o.send(e)},this),o.socket.addEventListener(egret.Event.CLOSE,function(e){o.emit("close",e),console.error("socket close: ")},this),o.socket.addEventListener(egret.IOErrorEvent.IO_ERROR,function(e){o.emit("io-error",e),console.error("socket error: ",e)},this),o.socket.addEventListener(egret.ProgressEvent.SOCKET_DATA,function(){console.log("SOCKET_DATA"),o.processPackage(o["package"].decode(o.socket.readUTF())),o.heartbeatTimeout&&(o.nextHeartbeatTimeout=Date.now()+o.heartbeatTimeout)},this),o.socket.connect(e,t)},i.on=function(e,t){(this._callbacks[e]=this._callbacks[e]||[]).push(t)},i.removeAllListeners=function(e,t){if(0==arguments.length)return void(this._callbacks={});var n=this._callbacks[e];if(n){if(1==arguments.length)return void delete this._callbacks[e];var r=this.index(n,t._off||t);~r&&n.splice(r,1)}},i.index=function(e,t){if([].indexOf)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1},i.disconnect=function(){this.socket&&(this.socket.close(),console.log("disconnect"),this.socket=null),this.heartbeatId&&(egret.clearTimeout(this.heartbeatId),this.heartbeatId=null),this.heartbeatTimeoutId&&(egret.clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null)},i.request=function(e,t,n){2===arguments.length&&"function"==typeof t?(n=t,t={}):t=t||{},e=e||t.route,e&&(this.reqId++,this.sendMessage(this.reqId,e,t),this.callbacks[this.reqId]=n,this.routeMap[this.reqId]=e)},i.sendMessage=function(e,t,o){var i=e?n.TYPE_REQUEST:n.TYPE_NOTIFY;o=this.protocol.strencode(JSON.stringify(o));var s=0;o=this.message.encode(e,i,s,t,o);var a=this["package"].encode(r.TYPE_DATA,o);this.send(a)},i.send=function(e){this.socket.writeUTF(e.buffer)},i.processPackage=function(e){this.handlers[e.type].call(this,e.body)},i.processMessage=function(e){if(!e.id)return void this.emit(e.route,e.body);var t=this.callbacks[e.id];delete this.callbacks[e.id],"function"==typeof t&&t(e.body)},i.heartbeat=function(e){if(this.heartbeatInterval){var t=this["package"].encode(r.TYPE_HEARTBEAT);if(this.heartbeatTimeoutId&&(egret.clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null),!this.heartbeatId){var n=this;n.heartbeatId=egret.setTimeout(function(){n.heartbeatId=null,n.send(t),n.nextHeartbeatTimeout=Date.now()+n.heartbeatTimeout,n.heartbeatTimeoutId=egret.setTimeout(n.heartbeatTimeoutCb,n,n.heartbeatTimeout)},n,n.heartbeatInterval)}}},i.heartbeatTimeoutCb=function(){var e=this.nextHeartbeatTimeout-Date.now();e>this.gapThreshold?this.heartbeatTimeoutId=egret.setTimeout(this.heartbeatTimeoutCb,this,e):(console.error("server heartbeat timeout"),this.emit("heartbeat timeout"),this.disconnect())},i.handshake=function(e){if(e=JSON.parse(this.protocol.strdecode(e)),e.code===this.RES_OLD_CLIENT)return void this.emit("error","client version not fullfill");if(e.code!==this.RES_OK)return void this.emit("error","handshake fail");this.handshakeInit(e);var t=this["package"].encode(r.TYPE_HANDSHAKE_ACK);this.send(t),this.initCallback&&(this.initCallback(this.socket),this.initCallback=null)},i.handshakeInit=function(e){e.sys&&e.sys.heartbeat?(this.heartbeatInterval=1e3*e.sys.heartbeat,this.heartbeatTimeout=2*this.heartbeatInterval):(this.heartbeatInterval=0,this.heartbeatTimeout=0),"function"==typeof this.handshakeCallback&&this.handshakeCallback(e.user)},i.onData=function(e){var t=this.message.decode(e);t.id>0&&(t.route=this.routeMap[t.id],delete this.routeMap[t.id],!t.route)||(t.body=this.deCompose(t),this.processMessage(t))},i.deCompose=function(e){return JSON.parse(this.protocol.strdecode(e.body))},i.onKick=function(e){this.emit("onKick")},i.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=[].slice.call(arguments,1),o=this._callbacks[e];if(o){o=o.slice(0);for(var i=0,s=o.length;s>i;++i)o[i].apply(this,r)}return this},e}();e.Pomelo=t,egret.registerClass(t,"pomeloClient.Pomelo");var n=function(){function e(){}var t=(__define,e),n=t.prototype;return n.encode=function(e,t,n,r,o){return"object"==typeof o&&(o=JSON.stringify(o)),{id:e,type:t,compressRoute:n,route:r,body:o}},n.decode=function(e){return e},e.TYPE_REQUEST=0,e.TYPE_NOTIFY=1,e.TYPE_RESPONSE=2,e.TYPE_PUSH=3,e}();egret.registerClass(n,"Message");var r=function(){function e(){}var t=(__define,e),n=t.prototype;return n.decode=function(e){return"string"==typeof e&&(e=JSON.parse(e)),e},n.encode=function(e,t){void 0===t&&(t="");var n={type:e,body:t};return{buffer:JSON.stringify(n)}},e.TYPE_HANDSHAKE=1,e.TYPE_HANDSHAKE_ACK=2,e.TYPE_HEARTBEAT=3,e.TYPE_DATA=4,e.TYPE_KICK=5,e}();egret.registerClass(r,"Package");var o=function(){function e(){}var t=(__define,e),n=t.prototype;return n.strencode=function(e){return e},n.strdecode=function(e){return"object"==typeof e&&(e=JSON.stringify(e)),e},e}();egret.registerClass(o,"Protocol")}(pomeloClient||(pomeloClient={}));var pomeloClient;!function(e){var t=function(){function e(){this.JS_WS_CLIENT_TYPE="js-websocket",this.JS_WS_CLIENT_VERSION="0.0.5",this.RES_OK=200,this.RES_FAIL=500,this.RES_OLD_CLIENT=501,this.socket=null,this.callbacks={},this.handlers={},this.routeMap={},this.heartbeatInterval=0,this.heartbeatTimeout=0,this.nextHeartbeatTimeout=0,this.gapThreshold=100,this.heartbeatId=null,this.heartbeatTimeoutId=null,this.handshakeCallback=null,this.initCallback=null,this._callbacks={},this.reqId=0,console.group||(console.group=console.log,console.groupEnd=function(){console.log("----")},console.info=console.log,console.warn=console.log,console.error=console.log),this._message=new r,this._package=new n,this.socket=null,this.callbacks={},this.handlers={},this.routeMap={},this.heartbeatInterval=0,this.heartbeatTimeout=0,this.nextHeartbeatTimeout=0,this.gapThreshold=100,this.heartbeatId=null,this.heartbeatTimeoutId=null,this.handshakeCallback=null,this.handshakeBuffer={sys:{type:this.JS_WS_CLIENT_TYPE,version:this.JS_WS_CLIENT_VERSION},user:{}},this.initCallback=null,this.reqId=0,this.handlers[n.TYPE_HANDSHAKE]=this.handshake,this.handlers[n.TYPE_HEARTBEAT]=this.heartbeat,this.handlers[n.TYPE_DATA]=this.onData,this.handlers[n.TYPE_KICK]=this.onKick}var t=(__define,e),a=t.prototype;return a.init=function(e,t){console.log("init",e),this.initCallback=t;var n=e.host,r=e.port;this.handshakeBuffer.user=e.user,this.handshakeCallback=e.handshakeCallback,this.initWebSocket(n,r,t)},a.initWebSocket=function(e,t,n){console.log("[web socket] connect to:",e,t),this.socket=new egret.WebSocket,this.socket.type=egret.WebSocket.TYPE_BINARY,this.socket.addEventListener(egret.Event.CONNECT,this.onConnect,this),this.socket.addEventListener(egret.Event.CLOSE,this.onClose,this),this.socket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onIOError,this),this.socket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onMessage,this),this.socket.connect(e,t)},a.on=function(e,t){(this._callbacks[e]=this._callbacks[e]||[]).push(t)},a.request=function(t,n,r){if(2===arguments.length&&"function"==typeof n?(r=n,n={}):n=n||{},t=t||n.route){this.reqId++,this.reqId>127&&(this.reqId=1);var o=this.reqId;e.DEBUG&&(console.group("REQUEST:"),console.info("Route:",t),console.log("Id:",o),console.log("Param:",n),console.groupEnd()),this.sendMessage(o,t,n),this.callbacks[o]=r,this.routeMap[o]=t}},a.onMessage=function(e){var t=new egret.ByteArray;this.socket.readBytes(t),this.processPackage(this._package.decode(t))},a.sendMessage=function(e,t,r){var o;o=this._message.encode(e,t,r),o=this._package.encode(n.TYPE_DATA,o),this.send(o)},a.onConnect=function(e){console.log("[Pomelo] connect success",e),this.socket.writeBytes(this._package.encode(n.TYPE_HANDSHAKE,o.strencode(JSON.stringify(this.handshakeBuffer)))),this.socket.flush()},a.onClose=function(t){console.error("[Pomelo] connect close:",t),this.emit(e.EVENT_CLOSE,t)},a.onIOError=function(t){this.emit(e.EVENT_IO_ERROR,t),console.error("socket error: ",t)},a.onKick=function(t){this.emit(e.EVENT_KICK,t)},a.onData=function(e){var t=this._message.decode(e);t.id>0&&(t.route=this.routeMap[t.id],delete this.routeMap[t.id],!t.route)||this.processMessage(t)},a.processMessage=function(t){if(!t.id)return e.DEBUG&&(console.group("EVENT:"),console.info("Route:",t.route),console.info("Msg:",t.body),console.groupEnd()),void this.emit(t.route,t.body);e.DEBUG&&(console.group("RESPONSE:"),console.info("Id:",t.id),console.info("Msg:",t.body),console.groupEnd());var n=this.callbacks[t.id];if(delete this.callbacks[t.id],"function"==typeof n){if(t.body&&500==t.body.code){var r={code:500,desc:"�������ڲ�����",key:"INTERNAL_ERROR"};t.body.error=r}n(t.body)}},a.heartbeat=function(e){if(this.heartbeatInterval){var t=this._package.encode(n.TYPE_HEARTBEAT);if(this.heartbeatTimeoutId&&(egret.clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null),!this.heartbeatId){var r=this;r.heartbeatId=egret.setTimeout(function(){r.heartbeatId=null,r.send(t),r.nextHeartbeatTimeout=Date.now()+r.heartbeatTimeout,r.heartbeatTimeoutId=egret.setTimeout(r.heartbeatTimeoutCb.bind(r,e),r,r.heartbeatTimeout)},r,r.heartbeatInterval)}}},a.heartbeatTimeoutCb=function(t){var n=this.nextHeartbeatTimeout-Date.now();n>this.gapThreshold?this.heartbeatTimeoutId=egret.setTimeout(this.heartbeatTimeoutCb,this,n):(console.error("server heartbeat timeout",t),this.emit(e.EVENT_HEART_BEAT_TIMEOUT,t),this._disconnect())},a.off=function(e,t){this.removeAllListeners(e,t)},a.removeAllListeners=function(e,t){if(0==arguments.length)return void(this._callbacks={});var n=this._callbacks[e];if(n){if(e&&!t)return void delete this._callbacks[e];var r=this.index(n,t._off||t);~r&&n.splice(r,1)}},a.index=function(e,t){if([].indexOf)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1},a.disconnect=function(){this._disconnect()},a._disconnect=function(){console.warn("[Pomelo] client disconnect ..."),this.socket&&this.socket.connected&&this.socket.close(),this.socket=null,this.heartbeatId&&(egret.clearTimeout(this.heartbeatId),this.heartbeatId=null),this.heartbeatTimeoutId&&(egret.clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null)},a.processPackage=function(e){this.handlers[e.type].apply(this,[e.body])},a.handshake=function(t){var r=JSON.parse(o.strdecode(t));if(r.code===this.RES_OLD_CLIENT)return void this.emit(e.EVENT_IO_ERROR,"client version not fullfill");if(r.code!==this.RES_OK)return void this.emit(e.EVENT_IO_ERROR,"handshake fail");this.handshakeInit(r);var i=this._package.encode(n.TYPE_HANDSHAKE_ACK);this.send(i),this.initCallback&&(this.initCallback(r),this.initCallback=null)},a.handshakeInit=function(e){e.sys&&(s.init(e.sys.dict),i.init(e.sys.protos)),e.sys&&e.sys.heartbeat?(this.heartbeatInterval=1e3*e.sys.heartbeat,this.heartbeatTimeout=2*this.heartbeatInterval):(this.heartbeatInterval=0,this.heartbeatTimeout=0),"function"==typeof this.handshakeCallback&&this.handshakeCallback(e.user)},a.send=function(e){this.socket&&this.socket.connected&&(this.socket.writeBytes(e),this.socket.flush())},a.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=[].slice.call(arguments,1),o=this._callbacks[e];if(o){o=o.slice(0);for(var i=0,s=o.length;s>i;++i)o[i].apply(this,r)}return this},e.DEBUG=!1,e.EVENT_IO_ERROR="io-error",e.EVENT_CLOSE="close",e.EVENT_KICK="onKick",e.EVENT_HEART_BEAT_TIMEOUT="heartbeat timeout",e}();e.PomeloBinary=t,egret.registerClass(t,"pomeloClient.PomeloBinary");var n=function(){function e(){}var t=(__define,e),n=t.prototype;return n.encode=function(e,t){var n=t?t.length:0,r=new egret.ByteArray;return r.writeByte(255&e),r.writeByte(n>>16&255),r.writeByte(n>>8&255),r.writeByte(255&n),t&&r.writeBytes(t,0,t.length),r},n.decode=function(e){var t,n=e.readUnsignedByte(),r=(e.readUnsignedByte()<<16|e.readUnsignedByte()<<8|e.readUnsignedByte())>>>0;return e.bytesAvailable>=r?(t=new egret.ByteArray,r&&e.readBytes(t,0,r)):console.log("[Package] no enough length for current type:",n),{type:n,body:t,length:r}},e.TYPE_HANDSHAKE=1,e.TYPE_HANDSHAKE_ACK=2,e.TYPE_HEARTBEAT=3,e.TYPE_DATA=4,e.TYPE_KICK=5,e}();egret.registerClass(n,"Package",["IPackage"]);var r=function(){function e(){}var t=(__define,e),n=t.prototype;return n.encode=function(t,n,r){var a=new egret.ByteArray,c=t?e.TYPE_REQUEST:e.TYPE_NOTIFY,u=i.encode(n,r)||o.strencode(JSON.stringify(r)),h=s.getID(n)||n;if(a.writeByte(c<<1|("string"==typeof h?0:1)),t)do{var l=t%128,d=Math.floor(t/128);0!=d&&(l+=128),a.writeByte(l),t=d}while(0!=t);return h&&("string"==typeof h?(a.writeByte(255&h.length),a.writeUTFBytes(h)):(a.writeByte(h>>8&255),a.writeByte(255&h))),u&&a.writeBytes(u),a},n.decode=function(t){var n,r=t.readUnsignedByte(),a=r&e.MSG_COMPRESS_ROUTE_MASK,c=r>>1&e.MSG_TYPE_MASK,u=0;if(c===e.TYPE_REQUEST||c===e.TYPE_RESPONSE){var h=0;do{var l=t.readUnsignedByte();u+=(127&l)*Math.pow(2,7*h),h++}while(l>=128)}if(c===e.TYPE_REQUEST||c===e.TYPE_NOTIFY||c===e.TYPE_PUSH)if(a)n=t.readUnsignedShort();else{var d=t.readUnsignedByte();n=d?t.readUTFBytes(d):""}u||"string"==typeof n||(n=s.getName(n));var _=i.decode(n,t)||JSON.parse(o.strdecode(t));return{id:u,type:c,route:n,body:_}},e.MSG_FLAG_BYTES=1,e.MSG_ROUTE_CODE_BYTES=2,e.MSG_ID_MAX_BYTES=5,e.MSG_ROUTE_LEN_BYTES=1,e.MSG_ROUTE_CODE_MAX=65535,e.MSG_COMPRESS_ROUTE_MASK=1,e.MSG_TYPE_MASK=7,e.TYPE_REQUEST=0,e.TYPE_NOTIFY=1,e.TYPE_RESPONSE=2,e.TYPE_PUSH=3,e}();egret.registerClass(r,"Message",["IMessage"]);var o=function(){function e(){}var t=(__define,e);t.prototype;return e.strencode=function(e){var t=new egret.ByteArray;return t.length=e.length,t.writeUTFBytes(e),t},e.strdecode=function(e){return e.readUTFBytes(e.bytesAvailable)},e}();egret.registerClass(o,"Protocol");var i=function(){function e(){}var t=(__define,e);t.prototype;return e.init=function(e){this._clients=e&&e.client||{},this._servers=e&&e.server||{}},e.encode=function(e,t){var n=this._clients[e];return n?this.encodeProtos(n,t):null},e.decode=function(e,t){var n=this._servers[e];return n?this.decodeProtos(n,t):null},e.encodeProtos=function(e,t){var n=new egret.ByteArray;for(var r in t)if(e[r]){var o=e[r];switch(o.option){case"optional":case"required":n.writeBytes(this.encodeTag(o.type,o.tag)),this.encodeProp(t[r],o.type,e,n);break;case"repeated":t[r]&&t[r].length>0&&this.encodeArray(t[r],o,e,n)}}return n},e.decodeProtos=function(e,t){for(var n={};t.bytesAvailable;){var r=this.getHead(t),o=e.__tags[r.tag];switch(e[o].option){case"optional":case"required":n[o]=this.decodeProp(e[o].type,e,t);break;case"repeated":n[o]||(n[o]=[]),this.decodeArray(n[o],e[o].type,e,t)}}return n},e.encodeTag=function(e,t){var n=void 0!=this.TYPES[e]?this.TYPES[e]:2;return this.encodeUInt32(t<<3|n)},e.getHead=function(e){var t=this.decodeUInt32(e);return{type:7&t,tag:t>>3}},e.encodeProp=function(e,t,n,r){switch(t){case"uInt32":r.writeBytes(this.encodeUInt32(e));break;case"int32":case"sInt32":r.writeBytes(this.encodeSInt32(e));break;case"float":var o=new egret.ByteArray;o.endian=egret.Endian.LITTLE_ENDIAN,o.writeFloat(e),r.writeBytes(o);break;case"double":var i=new egret.ByteArray;i.endian=egret.Endian.LITTLE_ENDIAN,i.writeDouble(e),r.writeBytes(i);break;case"string":r.writeBytes(this.encodeUInt32(e.length)),r.writeUTFBytes(e);break;default:var s=n.__messages[t]||this._clients["message "+t];if(s){var a=this.encodeProtos(s,e);r.writeBytes(this.encodeUInt32(a.length)),r.writeBytes(a)}}},e.decodeProp=function(t,n,r){switch(t){case"uInt32":return this.decodeUInt32(r);case"int32":case"sInt32":return this.decodeSInt32(r);case"float":var o=new egret.ByteArray;r.readBytes(o,0,4),o.endian=egret.Endian.LITTLE_ENDIAN;r.readFloat();return o.readFloat();case"double":var i=new egret.ByteArray;return r.readBytes(i,0,8),i.endian=egret.Endian.LITTLE_ENDIAN,i.readDouble();case"string":var s=this.decodeUInt32(r);return r.readUTFBytes(s);default:var a=n&&(n.__messages[t]||this._servers["message "+t]);if(a){var c=this.decodeUInt32(r);if(c){var u=new egret.ByteArray;r.readBytes(u,0,c)}return c?e.decodeProtos(a,u):!1}}},e.isSimpleType=function(e){return"uInt32"===e||"sInt32"===e||"int32"===e||"uInt64"===e||"sInt64"===e||"float"===e||"double"===e},e.encodeArray=function(e,t,n,r){var o=this.isSimpleType;if(o(t.type)){r.writeBytes(this.encodeTag(t.type,t.tag)),r.writeBytes(this.encodeUInt32(e.length));for(var i=this.encodeProp,s=0;s<e.length;s++)i(e[s],t.type,n,r)}else for(var a=this.encodeTag,c=0;c<e.length;c++)r.writeBytes(a(t.type,t.tag)),this.encodeProp(e[c],t.type,n,r)},e.decodeArray=function(e,t,n,r){var o=this.isSimpleType,i=this.decodeProp;if(o(t))for(var s=this.decodeUInt32(r),a=0;s>a;a++)e.push(i(t,n,r));else e.push(i(t,n,r))},e.encodeUInt32=function(e){var t=new egret.ByteArray;do{var n=e%128,r=Math.floor(e/128);0!==r&&(n+=128),t.writeByte(n),e=r}while(0!==e);return t},e.decodeUInt32=function(e){for(var t=0,n=0;n<e.length;n++){var r=e.readUnsignedByte();if(t+=(127&r)*Math.pow(2,7*n),128>r)return t}return t},e.encodeSInt32=function(e){return e=0>e?2*Math.abs(e)-1:2*e,this.encodeUInt32(e)},e.decodeSInt32=function(e){var t=this.decodeUInt32(e),n=t%2===1?-1:1;return t=(t%2+t)/2*n},e.TYPES={uInt32:0,sInt32:0,int32:0,"double":1,string:2,message:2,"float":5},e._clients={},e._servers={},e}();egret.registerClass(i,"Protobuf");var s=function(){function e(){}var t=(__define,e);t.prototype;return e.init=function(e){this._names=e||{};var t=this._names,n=this._ids;for(var r in t)n[t[r]]=r},e.getID=function(e){return this._names[e]},e.getName=function(e){return this._ids[e]},e._ids={},e._names={},e}();egret.registerClass(s,"Routedic")}(pomeloClient||(pomeloClient={}));var pomelo=new pomeloClient.PomeloBinary,logger;!function(e){var t;!function(t){e.initLogger(e.net,"net"),e.setLvl("net",4)}(t=e.net||(e.net={}))}(logger||(logger={}));var mo;!function(e){function t(e){p=e.net||p,E=e.reccnView||E,v=e.kickView||v,y=e.recnnFailed||y,T=e.netErrorView||T}function n(e,t,n,r){p.request.apply(p,arguments)}function r(e,t,n,r){p.requestWaiting.apply(p,arguments)}function o(e,t,n,r){p.request4Pomelo.apply(p,arguments)}function i(e,t,n,r){p.requestWaiting4Pomelo.apply(p,arguments)}function s(e,t){p.connect4Server.apply(p,arguments)}function a(e,t){p.disconnect4Server.apply(p,arguments)}function c(e,t,n,r){p.request4Server.apply(p,arguments)}function u(e,t,n,r){p.requestWaiting4Server.apply(p,arguments)}function h(e,t,n,r){p.request4Http.apply(p,arguments)}function l(e,t,n,r){p.requestWaiting4Http.apply(p,arguments)}function d(e,t){void 0===t&&(t=!0),p.connect.apply(p,arguments)}function _(){p.disconnect()}var g=function(){function e(){}var t=(__define,e);t.prototype;return e}();e._NetRequestInfo=g,egret.registerClass(g,"mo._NetRequestInfo");var f=function(t){function n(){t.apply(this,arguments),this.httpKey_crypt="c",this._curHttpRetryTimes=0}__extends(n,t);var r=(__define,n),o=r.prototype;return o._initProp=function(){t.prototype._initProp.call(this);var e=this;e._requestIdCounter=1,e._waitingRequestMap={},e._connected=!1,e._waitingQueue=[],e._waitingReq4PomeloQueue=[],e._connectType=0,e._serverConnected=!1,e._httpConnected=!1},o.connect=function(t,n){void 0===n&&(n=!0);var r=this;if(!r._connecting){r._connecting=!0,n&&e.playWaiting();var o=e.getLocalStorageItem(r.key_host,!0),i=e.getLocalStorageItem(r.key_port,!0);r._initConnectEvents(),logger.net.info("connect host【%s】:port【%s】",o,i),pomelo.init({host:o,port:i,log:r.logServer,maxReconnectAttempts:20},function(){r._kicked=!1,r._connecting=!1,r._connected=!0,r._connectType=1,n&&e.stopWaiting(),t();for(var o=r._waitingReq4PomeloQueue;o.length>0;){var i=o.pop();i&&i()}})}},o.disconnect=function(){pomelo.disconnect()},o.asyncAccount=function(e,t,n){void 0===t&&(t=!0),void 0===n&&(n=!0),this._reconnecting=!1,n&&(this._hasAsyncAccount=!0),e()},o._reconnect=function(e){var t=this,n=t._waitingQueue;if(e&&n.push(e),!t._reconnecting){t._reconnecting=!0;var r=function(){for(logger.net.info("重连成功！");n.length>0;)t._doRequest(n.pop())},o=t._connectType;if(logger.net.info("connectType------>",o),1==o)t._connectType=2,t.asyncAccount(r,!1,!1);else if(2==o){var i=Date.newDate();E.show(function(){var e=Date.newDate();logger.net.info(e.getTime(),i.getTime()),e.getTime()-i.getTime()>1e4?(t.reset(),y()):(t._connectType=3,t.asyncAccount(r,!0,!1))})}else 3==o&&(t._connecting=!0,E.show(function(){t.reset(),y()}))}},o.request=function(e,t,n,r){var o=this,i=o._getRequestInfo.apply(o,arguments);i.toPlayWaiting=!1,o._request(i)},o.requestWaiting=function(t,n,r,o){var i=this,s=i._getRequestInfo.apply(i,arguments);s.toPlayWaiting=!0,e.playWaiting(),i._request(s)},o.request4Pomelo=function(e,t,n,r){var o=this,i=o._getRequestInfo.apply(o,arguments);i.toPlayWaiting=!1,o._request(i,!0)},o.requestWaiting4Pomelo=function(t,n,r,o){var i=this,s=i._getRequestInfo.apply(i,arguments);s.toPlayWaiting=!0,e.playWaiting(),i._request(s,!0)},o.connect4Server=function(t,n){var r=this,o=e.getLocalStorageItem(r.key_host,!0),i=e.getLocalStorageItem(r.key_port,!0);r._serverHost=o,r._serverPort=i;var s=r._getRequestInfo(r.httpConnectRoute,{},function(e){r._httpSessionId=e[0],r._serverConnected=!0,r._serverCryptKey=e[1],t.call(n,e)},r);r._doRequestHttp(s,o,i)},o.disconnect4Server=function(e,t){var n=this,r=n._getRequestInfo(n.httpDisconnectRoute,{},function(r){n._serverConnected=!1,n._httpConnected=!0,e.call(t)},n);n._doRequestHttp(r,n._serverHost,n._serverPort)},o.connect4Http=function(e,t){var n=this,r=n._getRequestInfo(n.httpConnectRoute,{},function(r){n._httpConnected=!0,n._httpCryptKey=r[1],e.call(t,r)},n);n._doRequestHttp(r,n.httpHost,n.httpPort)},o.disconnect4Http=function(e,t){var n=this,r=n._getRequestInfo(n.httpDisconnectRoute,{},function(r){n._httpConnected=!1,e.call(t)},n);n._doRequestHttp(r,n.httpHost,n.httpPort)},o.request4Http=function(e,t,n,r){var o=this,i=o._getRequestInfo.apply(o,arguments);i.toPlayWaiting=!1,delete o._waitingRequestMap[i.requestId],o._requestHttp(i)},o.requestWaiting4Http=function(t,n,r,o){var i=this,s=i._getRequestInfo.apply(i,arguments);s.toPlayWaiting=!0,delete i._waitingRequestMap[s.requestId],e.playWaiting(),i._requestHttp(s)},o.request4Server=function(e,t,n,r){var o=this,i=o._getRequestInfo.apply(o,arguments);i.toPlayWaiting=!1,delete o._waitingRequestMap[i.requestId],o._requestHttp(i,!0)},o.requestWaiting4Server=function(t,n,r,o){var i=this,s=i._getRequestInfo.apply(i,arguments);s.toPlayWaiting=!0,delete i._waitingRequestMap[s.requestId],e.playWaiting(),i._requestHttp(s,!0)},o._getRequestInfo=function(e,t,n,r,o){var i=this,s=arguments.length;if(2>s||s>6)throw"Arguments error for request!";for(var a,c,u,h=1;s>h;h++){var l=arguments[h];if("object"!=typeof l&&null!=l||c)if("function"!=typeof l||c)if("object"!=typeof l&&null!=l||!c||u){if(!u)throw"Arguments error for request!";l.target=u.target,u=l}else u={target:l};else c=l;else a=l}a=a||{},a.t=Date.newDate().getTime(),a.dhid=quma.DHID||"",a.channel=quma.CHANNEL||"",u=u||{},u.cb=c;var d=i._requestIdCounter++,_=new g;return _.requestId=d,_.route=e||"",_.args=JSON.stringify(a||{}),_.cb=u.cb,_.ctx=u.target,_.isHttp=e.split(".")[0]==i.httpKey_handler,_.toPlayWaiting=!1,i._waitingRequestMap[d]=_,_},o._request=function(e,t){void 0===t&&(t=!1);var n=this;n._kicked||n._waitingRequestMap[e.requestId]&&(t||!n._hasAsyncAccount||n._connected?n._doRequest(e):n._reconnect(e))},o._doRequest=function(e){var t=this;t._kicked||t._waitingRequestMap[e.requestId]&&(e.isHttp?t._requestHttp(e):t._requestPomelo(e))},o._getHttpParams=function(e){var t=this,n=e.route,r=e.args,o="/?";return o+=t.httpKey_route+"="+n,o+="&"+t.httpKey_args+"="+r,o+="&"+t.httpKey_sessionId+"="+t._httpSessionId||"",o+="&"+t.httpKey_crypt+"="+(e.isCrypt?1:0)},o._requestHttp=function(e,t){var n=this,r="",o="";if(n._calCrypt(e,t),t)n._serverConnected?(r=n._serverHost,o=n._serverPort,n._doRequestHttp(e,r,o)):n.connect4Server(function(){n._requestHttp(e,t)},n);else if(n._httpConnected){r=n.httpHost,o=n.httpPort;e.route,e.args;n._doRequestHttp(e,r,o)}else n.connect4Http(function(){n._requestHttp(e,t)},n)},o._calCrypt=function(e,t){var n=this;t&&n._serverCryptKey&&(e.route=crypt.enCharCode(n._serverCryptKey,e.route),e.args=crypt.enCharCode(n._serverCryptKey,e.args),e.isCrypt=!0),!t&&n._httpCryptKey&&(e.route=crypt.enCharCode(n._httpCryptKey,e.route),e.args=crypt.enCharCode(n._httpCryptKey,e.args),e.isCrypt=!0)},o._doRequestHttp=function(t,n,r){var o=this,i=t.route,s=(t.args,e.httpMode+n+":"+r+o._getHttpParams(t));logger.net.info("http模式请求开始：%s",s);var a=new egret.URLLoader,c=new egret.URLRequest(s);a.dataFormat=egret.URLLoaderDataFormat.TEXT,a.load(c);var u=function(e){a.removeEventListener(egret.Event.COMPLETE,u,o),a.removeEventListener(egret.IOErrorEvent.IO_ERROR,h,o),o._handleRequestResult(t,JSON.parse(a.data))},h=function(e){a.removeEventListener(egret.Event.COMPLETE,u,o),a.removeEventListener(egret.IOErrorEvent.IO_ERROR,h,o),logger.net.error(i,"--->",e.type,a.data),o._onClose(e)};a.addEventListener(egret.Event.COMPLETE,u,o),a.addEventListener(egret.IOErrorEvent.IO_ERROR,h,o)},o._requestPomelo=function(e){var t=this,n=e.route,r=e.args,o=JSON.stringify(r),i=function(){logger.net.info("pomelo模式请求开始：%s ? %s",n,o),pomelo.request(n,r||{},function(n){t._handleRequestResult(e,n)})};t._connected?i():t._connecting?(logger.net.info("pomelo模式请求【%s ? %s】等待connect！",n,o),t._waitingReq4PomeloQueue.push(i),t.connect(function(){})):(logger.net.info("pomelo模式请求【%s ? %s】先进行connect！",n,o),t.connect(i))},o._handleRequestResult=function(t,n){var r=this,o=r.__class,i=r._waitingRequestMap,s=t.requestId;delete i[s],t.toPlayWaiting&&e.stopWaiting();var a=t.route,c=t.cb,u=t.ctx,h=o.ON_ROUTE_ERROR;if(n.code){var l=n.msg;l&&(logger.net.error("服务端返回错误信息：%s",l),e.showMsg(l)),r.emit(h+"_"+a,null,l,l),r.emit(h,a,null,l,l)}else{var d=n[r.respKey_msgCode];if(null==d){var _=n[r.respKey_value];c&&c.call(u,_),r.emit(o.ON_ROUTE_SUCCESS+"_"+a,_)}else{var g=n[r.respKey_msgArgs],f=g||[];f.splice(0,0,d),f&&24==f[0]?e.showMsg(24,function(){mo_channel.getCurChannel().logout(function(){})}):e.showMsg.apply(e,f),r.emit(h+"_"+a,null,d,g),r.emit(h,a,null,d,g)}}},o._showNetErrMsg=function(){var t=this;if(!t._netErrShown){var n=t.httpRetryMaxTimes||0,r=t._curHttpRetryTimes++;r>=n&&(T.show(function(){t._netErrShown=!1,t._waitingReq4PomeloQueue.length=0,e.stopWaitingForce()}),t._netErrShown=!0,t._curHttpRetryTimes=0)}},o._initConnectEvents=function(){var t=this,n=t.__class;t._connectEventsInited||(t._connectEventsInited=!0,pomelo.on("io-error",function(r){e.stopWaiting(),logger.net.error("net#链接出错!"),t._connected=!1,t._connecting=!1,t._reconnecting=!1,t.emit(n.ON_ERROR),t._hasAsyncAccount||t._showNetErrMsg()}),pomelo.on("a",function(e){logger.net.info(e)}),pomelo.on("close",function(n){e.stopWaiting(),logger.net.error("net#链接断开!"),t._onClose(n)}),pomelo.on("onKick",function(r){logger.net.debug("被踢出!"),e.stopWaiting(),t._kicked=!0,t._connected=!1,t.emit(n.ON_CLOSE),v.show(function(){t.reset()})}))},o._onClose=function(t){e.stopWaiting();var n=this,r=n.__class;if(n._connected=!1,n._connecting=!1,n.emit(r.ON_CLOSE),n._hasAsyncAccount){var o=n._connectType;(2==o||3==o)&&n._reconnect()}else n._showNetErrMsg()},o.onRouteSuccess=function(e,t,n){this.on(this.__class.ON_ROUTE_SUCCESS+"_"+e,t,n)},o.unRouteSuccess=function(e,t,n){this.un(this.__class.ON_ROUTE_SUCCESS+"_"+e,t,n)},o.onRouteError=function(e,t,n){this.on(this.__class.ON_ROUTE_ERROR+"_"+e,t,n)},o.unRouteError=function(e,t,n){this.un(this.__class.ON_ROUTE_ERROR+"_"+e,t,n)},o.reset=function(){var t=this;t._kicked=!1,t._connected=!1,t._connecting=!1,t._hasAsyncAccount=!1,t._connectType=0,t._waitingQueue.length=0;var n=t._waitingRequestMap;for(var r in n)delete n[r];t._requestIdCounter=0,e.stopWaitingForce()},n.ON_ERROR="error",n.ON_CLOSE="close",n.ON_KICK="kick",n.ON_SUCCESS="success",n.ON_ROUTE_ERROR="resultError",n.ON_ROUTE_SUCCESS="resultSuccess",n}(egret.Emitter);e.Net=f,egret.registerClass(f,"mo.Net");var p=new f,E={show:function(e){}},v={show:function(e){}},y=function(){},T={show:function(){}};e.registerNet=t,e.request=n,e.requestWaiting=r,e.request4Pomelo=o,e.requestWaiting4Pomelo=i,e.connect4Server=s,e.disconnect4Server=a,e.request4Server=c,e.requestWaiting4Server=u,e.request4Http=h,e.requestWaiting4Http=l,e.connect=d,e.disconnect=_,e.httpMode="http://"}(mo||(mo={}));